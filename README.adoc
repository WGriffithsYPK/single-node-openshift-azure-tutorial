:data-uri:
:toc:

= single-node-openshift-azure-demo

== What is this?

This simple tutorial/demo script will talk you through the creation of a single virtual machine (node) on Azure that is running OpenShift. It will use the "oc cluster up" mechanism to deploy OpenShift, which is great just for demos, labs, and that sort of thing. 

This would not be the recommended way for a production deployment of OpenShift on Azure. If you want to learn more about that, then check out this repository instead; http://aka.ms/openshift

=== What do I need before I get started?

1. A working Azure account with at least $50 credit.
2. Access to Red Hat OpenShift Container Platform subscriptions (NFRs, or lab repositories). 

[NOTE]
This lab would also work with OKD (community OpenShift), but the instructions and repositories would be a little different. Unfortunately you are on your own if you want to try OKD!

=== What will I do in this demo?

1. You'll need a working Azure subscription and portal login to complete this demo.
2. Create a Azure RHEL virtual machine and connect to it with SSH.
3. Enable the OpenShift repositories. 
4. Configure Docker, and start a simple "all in one" OpenShift environment.
5. Profit! ... and then run more exciting OpenShift workloads on Azure ;-)

This lab should between 30 and 45 minutes to complete.

[NOTE]
Instructions may be deliberately brief, **encouraging you to look into the answer 
 a little yourself**. Don’t be upset if some steps take you a little longer to 
 find or fix, but do ask for help if you get stuck too long! 


== Provision a RHEL virtual machine from the marketplace 

Naviate to the Azure Marketplace;

image::images/marketplaceRhel.png[]

Provision a new RHEL 7.x machine. Use the latest version of RHEL available (7.6 at the time of writing). Use common sense details for the VM hostname, etc.

    * **Authentication Type**: You should use a SSH key if you have one, otherwise, create a **strong password**!
    * **Resource Group**: Create new: __openshift_occlusterup__
    * **Location**: Use a region that is near to you!

image::images/provisioningDialog.png[]

=== Sizing

For the machine size, HDD storage on a standard policy will be just fine. Standard_DS3_v2 or Standard_D4s_v3 work quite nicely. 

Use managed disks, a 20Gb virtual disk size. 

=== Set a DNS name

When the virtual machine has been provisioned, set a DNS name in the virtual machine overview and take a note of the public IP address. 

image::images/dnsName.png[]

=== Edit the Network Security Groups, and add a few basic rules; 

image::images/dnsName.png[]

=== SSH into your VM

Get ready for some OpenShifting :-)

== Prepare the machine for OpenShift

== Disconnect from Red Hat Update Infrastructure; 

RHEL machines provisioned from the marketplace come connected to Red Hat Update Infrastructure. However, Red Hat Update Infrastructure is for RHEL only, not OpenShift.

    root@openshift-allinone: rpm -e rhui-azure-rhel7

=== Option a) If you have a working Red Hat subscription; 

    subscription-manager register
    Username: …
    Password: …

Find a pool ID with OpenShift, and make a note of the pool ID.

    subscription-manager list --available

Attach to this pool;

    subscription-manager attach --pool=...

Disable all default repos, and then attach to the required repos.

    subscription-manager repos --disable ‘*’

    subscription-manager repos --enable ‘rhel-7-server-rpms’
    subscription-manager repos --enable ‘rhel-7-server-extras-rpms’
    subscription-manager repos --enable ‘rhel-7-server-ose-3.6-rpms’

=== Option b) If you have a repository provided by your lab administrator; 

    cd /etc/yum.repos.d/
    wget http://YOUR-ADDRESS-HERE.cloudapp.azure.com/repos/lab.repo 

=== Install the `oc` client and Git

    yum install atomic-openshift-clients git -y

=== Install and setup Docker

    yum install docker
   
Add the insecure registry options `--insecure-registry=172.30.0.0/16` to the docker config file;

    vim /etc/sysconfig/docker

Make docker start on boot, and then start it manually;

    systemctl enable docker
    systemctl start docker

=== Configure iptables

    service iptables start
    iptables -F INPUT

=== Start OpenShift

    oc cluster up --public-hostname=<yourDnsName>.azure.com --routing-suffix=<yourPublicIpAddress>.nip.io

=== Login to the web interface

http://<yourDnsName>.azure.com:8443

Have a little look around ;-) You can login as *developer* with any password.

== Service Broker for Azure


=== Create a service principal 

https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal

=== Install the service broker

Install the service broker using instructions from here;

https://github.com/Azure/open-service-broker-azure#openshift-project-template

== What can I try now? 

1. Deploy `php-show-my-hostname`; https://github.com/jamesread/php-show-my-hostname.git 
2. If you know quite a lot about OpenShift already, but not Azure, start from challenge #7; https://github.com/palma21/openshiftlab#challenge--7-monitoring-openshift-with-azure-oms
3. If you know quite a lot about Azure already, but not OpenShift, start from challenge #2; https://github.com/palma21/openshiftlab#challenge--2-create-and-manage-projects
4. .NET and Azure focussed OpenShift demo; https://github.com/city-breaks-on-openshift
5. If you fancy a challenge; https://github.com/jbossdemocentral/coolstore-microservice
